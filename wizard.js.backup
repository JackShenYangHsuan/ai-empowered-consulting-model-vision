// Agent Creation Wizard

class AgentWizard {
    constructor() {
        this.currentStep = 1;
        this.totalSteps = 4;
        this.formData = {
            objective: '',
            description: '',
            tools: ['web-search', 'code-executor'],
            workplan: [],
            clarifications: [],
            agentId: null,
            executionResults: null
        };
        this.apiClient = window.apiClient || new APIClient();
        
        this.init();
    }
    
    init() {
        this.setupEventListeners();
        this.setupStep2EventListeners();
        this.setupStep3EventListeners();
        this.setupStep4EventListeners();
    }
    
    open() {
        document.getElementById('agentWizard').classList.add('active');
        this.reset();
    }
    
    close() {
        document.getElementById('agentWizard').classList.remove('active');
    }
    
    reset() {
        this.currentStep = 1;
        this.formData = {
            objective: '',
            description: '',
            tools: ['web-search', 'code-executor']
        };
        
        // Reset UI
        document.getElementById('agentObjective').value = '';
        document.getElementById('agentDescription').value = '';
        this.updateStepIndicators();
        this.showStep(1);
    }
    
    setupEventListeners() {
        // Open wizard
        const newAgentBtn = document.getElementById('newAgentBtn');
        const addAgentBtn = document.getElementById('addAgentBtn');
        if (newAgentBtn) {
            newAgentBtn.addEventListener('click', () => this.open());
        }
        if (addAgentBtn) {
            addAgentBtn.addEventListener('click', () => this.open());
        }
        
        // Close wizard
        document.getElementById('wizardClose')?.addEventListener('click', () => this.close());
        document.getElementById('wizardCancel')?.addEventListener('click', () => this.close());
        
        // Click outside to close
        document.getElementById('agentWizard')?.addEventListener('click', (e) => {
            if (e.target.id === 'agentWizard') {
                this.close();
            }
        });
        
        // Step 1 navigation
        document.getElementById('wizardNext')?.addEventListener('click', () => this.nextStep());
        
        // Tool selection
        this.setupToolSelection();
        
        // Form inputs
        document.getElementById('agentObjective')?.addEventListener('input', (e) => {
            this.formData.objective = e.target.value;
        });
        
        document.getElementById('agentDescription')?.addEventListener('input', (e) => {
            this.formData.description = e.target.value;
        });
    }
    
    setupToolSelection() {
        // Remove tool
        document.getElementById('selectedTools')?.addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.tool-remove');
            if (removeBtn) {
                const chip = removeBtn.closest('.tool-chip');
                const tool = chip.dataset.tool;
                this.removeTool(tool);
                chip.remove();
            }
        });
        
        // Add tool from suggestions
        document.querySelectorAll('.tool-suggestion-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tool = btn.dataset.tool;
                const toolName = btn.textContent.trim().replace('+ ', '');
                this.addTool(tool, toolName);
            });
        });
        
        // Add tool from input
        document.getElementById('addToolBtn')?.addEventListener('click', () => {
            const input = document.getElementById('toolInput');
            const toolName = input.value.trim();
            if (toolName) {
                const toolId = toolName.toLowerCase().replace(/\s+/g, '-');
                this.addTool(toolId, toolName);
                input.value = '';
            }
        });
        
        // Add on Enter key
        document.getElementById('toolInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('addToolBtn').click();
            }
        });
    }
    
    addTool(toolId, toolName) {
        // Check if already added
        if (this.formData.tools.includes(toolId)) {
            return;
        }
        
        this.formData.tools.push(toolId);
        
        // Create chip
        const chip = document.createElement('div');
        chip.className = 'tool-chip selected';
        chip.dataset.tool = toolId;
        
        // Get icon based on tool type
        const icon = this.getToolIcon(toolId);
        
        chip.innerHTML = `
            <span class="tool-icon">${icon}</span>
            <span class="tool-name">${toolName}</span>
            <button class="tool-remove">Ã—</button>
        `;
        
        document.getElementById('selectedTools').appendChild(chip);
    }
    
    removeTool(toolId) {
        const index = this.formData.tools.indexOf(toolId);
        if (index > -1) {
            this.formData.tools.splice(index, 1);
        }
    }
    
    getToolIcon(toolId) {
        const icons = {
            'web-search': 'ğŸ”',
            'code-executor': 'ğŸ’»',
            'database-query': 'ğŸ—„ï¸',
            'file-reader': 'ğŸ“„',
            'api-caller': 'ğŸ”Œ',
            'email-sender': 'ğŸ“§',
            'data-analyzer': 'ğŸ“Š',
            'image-generator': 'ğŸ¨'
        };
        return icons[toolId] || 'ğŸ”§';
    }
    
    nextStep() {
        // Validate current step
        if (!this.validateCurrentStep()) {
            return;
        }
        
        // Move to next step
        if (this.currentStep < this.totalSteps) {
            this.currentStep++;
            this.showStep(this.currentStep);
            this.updateStepIndicators();
        }
    }
    
    prevStep() {
        if (this.currentStep > 1) {
            this.currentStep--;
            this.showStep(this.currentStep);
            this.updateStepIndicators();
        }
    }
    
    validateCurrentStep() {
        if (this.currentStep === 1) {
            if (!this.formData.objective.trim()) {
                alert('Please enter an objective for your agent.');
                return false;
            }
            if (!this.formData.description.trim()) {
                alert('Please provide a description of what your agent should do.');
                return false;
            }
            if (this.formData.tools.length === 0) {
                alert('Please select at least one tool for your agent.');
                return false;
            }
        }
        return true;
    }
    
    showStep(stepNumber) {
        // Hide all steps
        document.querySelectorAll('.wizard-step').forEach(step => {
            step.classList.remove('active');
        });
        
        // Show target step
        const targetStep = document.querySelector(`.wizard-step[data-step="${stepNumber}"]`);
        if (targetStep) {
            targetStep.classList.add('active');
        }
    }
    
    updateStepIndicators() {
        document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
            const stepNum = index + 1;
            const circle = indicator.querySelector('.step-circle');
            
            // Remove all states
            circle.classList.remove('active', 'completed');
            
            // Add appropriate state
            if (stepNum < this.currentStep) {
                circle.classList.add('completed');
                circle.textContent = 'âœ“';
            } else if (stepNum === this.currentStep) {
                circle.classList.add('active');
                circle.textContent = stepNum;
            } else {
                circle.textContent = stepNum;
            }
        });
    }
    
    getFormData() {
        return { ...this.formData };
    }
}

// Initialize wizard when DOM is ready
let agentWizard;
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        agentWizard = new AgentWizard();
    });
} else {
    agentWizard = new AgentWizard();
}
